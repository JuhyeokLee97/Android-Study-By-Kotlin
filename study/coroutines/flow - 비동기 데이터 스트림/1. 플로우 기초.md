# Flow 기초
Coroutine에서 쓸 수 있는 비동기 스트림이다.
- Coroutine을 사용함으로써 순차적이고 변화 추적이 가능하다.

`emit()`: 방출, 스트림에 값을 보내다.
`collect()`: 수집, 스트림에서 방출된 값을 수신한다.
 - collect 요청을 해야 flow 동작이 실행된다. Flow는 `Cold Stream`이기 때문에 요청 측에서 collect를 호출해야 값을 발생시킨다.
 - `Cold Stream`: 요청이 있는 경우에 보통 1:1로 값을 전달하기 시작한다.
 - `Hot Stream`: 0개 이상의 상대를 향해 지속적으로 값을 전달한다.

## 1 FlowBuilder: `flow{}`, `flowOf()`, `asFlow()`

### 1.1 `flow{}`
``` kotlin
import kotlin.random.Random
import kotlinx.coroutines.*
import kotlinx.coroutines.flow.*

fun flowSomething(): Flow<Int> = flow {
    repeat(10) {
        emit(Random.nextInt(0, 500))
        delay(10L)
    }
}

fun main() = runBlocking {
    flowSomething().collect { value ->
    	println("collected value: $value")
    }
}
```

<details>
<summary>실행 결과 보기</summary>

```
collected value: 480  
collected value: 490  
collected value: 186  
collected value: 407  
collected value: 173  
collected value: 101  
collected value: 478  
collected value: 92  
collected value: 316  
collected value: 463
```
</details>

### 1.2. `flowOf()`
flowOf는 여러 값을 인자로 전달해 플로우를 만듭니다.
함수 내부에서 인자로 전달받은 값을 emit()하고 있어서 별도로 emit()처리가 필요하지 않다.

``` kotlin
import kotlinx.coroutines.*
import kotlinx.coroutines.flow.*

fun main() = runBlocking {
    flowOf(1, 2, 3, 4, 5).collect { value ->
    	println("collected value: $value")
    }
}
```

<details>
<summary>실행 결과 보기</summary>

```
collected value: 1
collected value: 2
collected value: 3
collected value: 4
collected value: 5
```
</details>

flowOf()는 flow{}를 통해 파라미터로 전달된 값들을 순차적으로 emit()하는 함수입니다.
``` kotlin
flowOf(1, 2, 3, 4, 5).collect {}
```
위 코드는 flow{}를 이용한 아래 코드와 동일합니다.
``` kotlin
flow {
    emit(1)
    emit(2)
    emit(3)
    emit(4)
    emit(5) 
}
```

### 1.3. `asFlow()`
Sequence 또는 Collection의 확장함수로 플로우를 만듭니다.
함수 내부에서 아이템을 emit()하고 있어서 별도로 emit()처리가 필요하지 않다.
``` kotlin
import kotlinx.coroutines.*
import kotlinx.coroutines.flow.*

fun main() = runBlocking {
    listOf(1, 2, 3, 4, 5).asFlow().collect { value ->
    	println("collected value: $value")
    }
}

```
<details>
<summary>실행 결과 보기</summary>

```
collected value: 1
collected value: 2
collected value: 3
collected value: 4
collected value: 5
```
</details>

asFlow()는 flow{}를 통해 원소를 순차적으로 emit()하는 함수입니다.
``` kotlin
listOf(1, 2, 3, 4, 5).asFlow().collect {}
```
위 코드는 flow{}를 이용한 아래 코드와 동일합니다.
``` kotlin
flow {
    emit(1)
    emit(2)
    emit(3)
    emit(4)
    emit(5) 
}
```

## 2 Flow 취소
Coroutine에서 제공하는 `withTimeoutOrNull()` 또는 `withTimeout()`을 통해서 간단히 취소할 수 있습니다.

### 2.1 `withTimeoutOrNull()`
``` kotlin
import kotlin.random.Random
import kotlinx.coroutines.*
import kotlinx.coroutines.flow.*

fun flowSomething(): Flow<Int> = flow {
    repeat(10) {
        emit(Random.nextInt(0, 500))
        delay(100L)
    }
}

fun main() = runBlocking {
    val result = withTimeoutOrNull(500L) {
        flowSomething().collect { value ->
        	println("collected value: $value")
        }
        true
    } ?: false
    
    if (!result) {
        println("취소되었습니다.")
    }
}
```

<details>
<summary>실행 결과 보기</summary>

```
collected value: 229
collected value: 269
collected value: 61
collected value: 404
collected value: 98
취소되었습니다.
```
</details>

### 2.2 `withTimeout()`
withTimeout() 사용 시, 예외가 던져지므로 별도의 예외처리가 필요합니다.

``` kotlin
import kotlin.random.Random
import kotlinx.coroutines.*
import kotlinx.coroutines.flow.*

fun flowSomething(): Flow<Int> = flow {
    repeat(10) {
        emit(Random.nextInt(0, 500))
        delay(100L)
    }
}

fun main() = runBlocking {
    val result = withTimeout(500L) {
        flowSomething().collect { value ->
        	println("collected value: $value")
        }
    }
}
```

<details>
<summary>실행 결과 보기(에러 로그 포함)</summary>

```
collected value: 97
collected value: 200
collected value: 365
collected value: 87
collected value: 204
Exception in thread "main" kotlinx.coroutines.TimeoutCancellationException: Timed out waiting for 500 ms
 at (Coroutine boundary. (:-1) 
 at FileKt$flowSomething$1.invokeSuspend (File.kt:-1) 
 at kotlinx.coroutines.flow.AbstractFlow.collect (Flow.kt:-1) 
Caused by: kotlinx.coroutines.TimeoutCancellationException: Timed out waiting for 500 ms
at kotlinx.coroutines.TimeoutKt .TimeoutCancellationException(Timeout.kt:184)
at kotlinx.coroutines.TimeoutCoroutine .run(Timeout.kt:154)
at kotlinx.coroutines.EventLoopImplBase$DelayedRunnableTask .run(EventLoop.common.kt:508)
```
</details>
